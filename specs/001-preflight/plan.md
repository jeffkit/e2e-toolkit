# Implementation Plan: Preflight

**Branch**: `001-preflight` | **Date**: 2026-02-12 | **Spec**: `specs/001-preflight/spec.md`
**Input**: Feature specification — 将现有 as-mate/e2e 测试系统重构为独立的、通用的 Docker Preflight

## Summary

将 `as-mate/e2e` 的 Docker 构建、容器管理、Mock Gateway、测试运行、Dashboard 等功能提取为一个通用的、配置驱动的 monorepo 工具包 (`preflight`)。核心价值：开发者只需提供 `Dockerfile + e2e.yaml`，即可获得完整的构建、部署、Mock、测试、调试体验。技术上采用 pnpm workspace monorepo，拆分为 `core`（引擎层）、`dashboard`（可视化层）、`cli`（命令层）三个包，通过 YAML 声明式配置统一驱动。

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode), Node.js 20+
**Primary Dependencies**: Fastify 5.x, React 18+, Vite 5+, Tailwind CSS 4+, Zod, js-yaml, Commander.js
**Storage**: 文件系统 (`e2e.yaml` + JSON 报告输出)；Dashboard 测试历史存内存 (in-memory)
**Testing**: Vitest（单元测试 + 集成测试）
**Target Platform**: Linux (primary), macOS (dev), Windows (WSL2)
**Project Type**: Monorepo (pnpm workspace)
**Performance Goals**: Mock 服务启动 < 3s，Mock 请求响应 < 100ms，Dashboard 操作响应 < 2s
**Constraints**: 依赖 Docker Engine/Desktop，零侵入被测服务，核心模块测试覆盖 ≥ 85%
**Scale/Scope**: 支持单容器服务 E2E 测试，MVP 阶段不涉及多容器编排

---

## Constitution Check

*GATE: Must pass before implementation. Re-check after each phase.*

| # | Principle | Status | Notes |
|---|-----------|--------|-------|
| 1 | Configuration-Driven Architecture | ✅ PASS | `e2e.yaml` 为核心配置，所有行为声明式驱动 |
| 2 | Language-Agnostic Testing | ✅ PASS | 支持 YAML/Vitest/Pytest/Shell/Exec 五种运行器 |
| 3 | Zero-Intrusion Testing | ✅ PASS | 仅需 Dockerfile + 网络可达，不修改服务代码 |
| 4 | TypeScript Strict Mode | ✅ PASS | `strict: true`，ESM，pnpm workspace |
| 5 | Test Coverage Requirements | ✅ PASS | 核心模块 85%+，整体 80%+ |
| 6 | Single Entry CLI | ✅ PASS | 统一 `preflight <subcommand>` |
| 7 | SSE Real-Time Feedback | ✅ PASS | 构建日志、容器日志、测试事件均走 SSE |
| 8 | Extensible Architecture | ✅ PASS | `TestRunner` 接口，可插拔运行器 |
| 9 | Web Framework: Fastify | ✅ PASS | Dashboard 后端 Fastify 5.x，前端 React+Vite+Tailwind |
| 10 | Node.js 20+ Runtime | ✅ PASS | 使用 native fetch, AbortController |

---

## Project Structure

### Documentation (this feature)

```text
specs/001-preflight/
├── plan.md              # This file
├── spec.md              # Feature specification
└── tasks.md             # Task breakdown (generated by speckit-tasks)
```

### Source Code — Monorepo Layout

```text
preflight/
├── package.json                    # Monorepo root (workspaces declaration)
├── pnpm-workspace.yaml             # pnpm workspace config
├── tsconfig.json                   # Root tsconfig (project references)
├── tsconfig.base.json              # Shared compiler options
├── vitest.workspace.ts             # Vitest workspace config
├── .env.example                    # 环境变量示例
├── .gitignore
├── README.md
│
├── packages/
│   ├── core/                       # @preflight/core — 核心引擎
│   │   ├── package.json
│   │   ├── tsconfig.json
│   │   ├── vitest.config.ts
│   │   ├── src/
│   │   │   ├── index.ts            # Public API barrel export
│   │   │   ├── types.ts            # 所有核心类型定义
│   │   │   ├── config-loader.ts    # e2e.yaml 加载 + Zod 校验
│   │   │   ├── docker-engine.ts    # Docker 镜像构建 + 容器生命周期
│   │   │   ├── test-runner.ts      # TestRunner 接口 + 运行器注册表
│   │   │   ├── yaml-engine.ts      # YAML 测试文件解析 + HTTP 执行
│   │   │   ├── assertion-engine.ts # 断言 DSL 引擎
│   │   │   ├── mock-generator.ts   # Mock 服务生成 (Fastify-based)
│   │   │   ├── sse-bus.ts          # SSE 事件总线
│   │   │   ├── reporter.ts         # 测试结果报告 (console/json/html)
│   │   │   ├── variable-resolver.ts# 模板变量解析 ({{timestamp}}, {{env.XX}})
│   │   │   └── runners/            # 内置测试运行器
│   │   │       ├── yaml-runner.ts  # YAML 声明式测试运行器
│   │   │       ├── vitest-runner.ts
│   │   │       ├── pytest-runner.ts
│   │   │       ├── shell-runner.ts
│   │   │       └── exec-runner.ts
│   │   └── tests/
│   │       ├── unit/
│   │       │   ├── config-loader.test.ts
│   │       │   ├── assertion-engine.test.ts
│   │       │   ├── variable-resolver.test.ts
│   │       │   ├── yaml-engine.test.ts
│   │       │   ├── mock-generator.test.ts
│   │       │   └── docker-engine.test.ts
│   │       └── integration/
│   │           ├── yaml-runner.test.ts
│   │           └── mock-service.test.ts
│   │
│   ├── dashboard/                  # @preflight/dashboard — 可视化面板
│   │   ├── package.json
│   │   ├── tsconfig.json
│   │   ├── tsconfig.node.json
│   │   ├── vite.config.ts
│   │   ├── vitest.config.ts
│   │   ├── index.html
│   │   ├── server/                 # Fastify 后端
│   │   │   ├── index.ts            # 服务器入口
│   │   │   └── routes/
│   │   │       ├── docker.ts       # Docker 操作 API
│   │   │       ├── test.ts         # 测试运行 API
│   │   │       ├── proxy.ts        # API 代理
│   │   │       ├── mock.ts         # Mock 管理 API
│   │   │       ├── config.ts       # 配置管理 API
│   │   │       └── events.ts       # SSE 事件端点
│   │   └── ui/                     # React 前端
│   │       ├── main.tsx
│   │       ├── App.tsx
│   │       ├── app.css
│   │       ├── components/
│   │       │   ├── Layout.tsx
│   │       │   ├── SSELogViewer.tsx
│   │       │   └── StatusBadge.tsx
│   │       ├── pages/
│   │       │   ├── BuildPage.tsx       # 镜像构建
│   │       │   ├── ContainerPage.tsx   # 容器管理
│   │       │   ├── ApiExplorerPage.tsx # API 调试
│   │       │   ├── TestSuitesPage.tsx  # 测试套件
│   │       │   └── LogsPage.tsx        # 日志查看
│   │       ├── stores/
│   │       │   ├── build-store.ts
│   │       │   ├── container-store.ts
│   │       │   └── test-store.ts
│   │       └── lib/
│   │           ├── api.ts              # API client
│   │           └── sse.ts              # SSE client helper
│   │
│   └── cli/                        # @preflight/cli — CLI 工具
│       ├── package.json
│       ├── tsconfig.json
│       ├── src/
│       │   ├── index.ts            # CLI 入口 (#!/usr/bin/env node)
│       │   ├── commands/
│       │   │   ├── init.ts         # preflight init
│       │   │   ├── setup.ts        # preflight setup
│       │   │   ├── build.ts        # preflight build
│       │   │   ├── run.ts          # preflight run
│       │   │   ├── status.ts       # preflight status
│       │   │   ├── clean.ts        # preflight clean
│       │   │   ├── logs.ts         # preflight logs
│       │   │   └── dashboard.ts    # preflight dashboard
│       │   └── utils/
│       │       ├── output.ts       # CLI 输出格式化 (chalk + ora)
│       │       └── sse-printer.ts  # SSE → 终端渲染
│       └── tests/
│           └── commands/
│               ├── init.test.ts
│               └── run.test.ts
│
└── templates/                      # preflight init 生成的模板文件
    └── default/
        ├── e2e.yaml                # 配置模板
        └── tests/
            └── health.yaml         # 示例测试
```

**Structure Decision**: 采用 pnpm workspace monorepo，三个包职责清晰分离：
- `core` — 纯逻辑引擎，无 HTTP server 依赖，可被 CLI 和 Dashboard 直接引用
- `dashboard` — 可视化层，Fastify server + React UI，调用 core API
- `cli` — 命令层，调用 core API，处理终端交互

---

## Core Module Design

### 1. config-loader — 配置加载与验证

**职责**: 加载 `e2e.yaml`，使用 Zod schema 严格验证，支持变量替换和 `.env` 加载。

**迁移来源**: 从 `as-mate/e2e` 的硬编码配置（分散在 `docker.ts` 和 `test.ts` 中的常量）提取为声明式配置系统。

**核心逻辑**:

```typescript
// config-loader.ts

import { z } from 'zod';
import yaml from 'js-yaml';
import fs from 'fs/promises';
import path from 'path';
import dotenv from 'dotenv';

// ===== Zod Schemas =====

const HealthcheckSchema = z.object({
  path: z.string(),
  interval: z.string().default('10s'),
  timeout: z.string().default('5s'),
  retries: z.number().default(10),
  start_period: z.string().default('30s'),
});

const ServiceBuildSchema = z.object({
  dockerfile: z.string(),
  context: z.string().default('.'),
  image: z.string(),
  args: z.record(z.string()).optional(),
  no_cache: z.boolean().default(false),
});

const ServiceContainerSchema = z.object({
  name: z.string(),
  ports: z.array(z.string()),           // "19000:3000"
  environment: z.record(z.string()).optional(),
  volumes: z.array(z.string()).optional(),
  healthcheck: HealthcheckSchema.optional(),
});

const MockRouteSchema = z.object({
  method: z.enum(['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS']),
  path: z.string(),
  response: z.object({
    status: z.number().default(200),
    headers: z.record(z.string()).optional(),
    body: z.unknown(),
    delay: z.string().optional(),       // "100ms", "2s"
  }),
  when: z.object({
    body: z.record(z.unknown()).optional(),
    headers: z.record(z.string()).optional(),
    query: z.record(z.string()).optional(),
  }).optional(),
});

const MockServiceSchema = z.object({
  port: z.number(),
  container_port: z.number().optional(),
  image: z.string().optional(),         // 自定义 Docker 镜像 (预置)
  routes: z.array(MockRouteSchema).optional(), // 声明式 Mock 路由
});

const TestSuiteSchema = z.object({
  name: z.string(),
  id: z.string(),
  file: z.string().optional(),
  runner: z.enum(['yaml', 'vitest', 'pytest', 'shell', 'exec']).default('yaml'),
  command: z.string().optional(),
  config: z.string().optional(),
  timeout: z.string().default('5m'),
  options: z.record(z.unknown()).optional(),
});

const DashboardSchema = z.object({
  port: z.number().default(9095),
  ui_port: z.number().default(9091),
});

const NetworkSchema = z.object({
  name: z.string().default('e2e-network'),
});

export const E2EConfigSchema = z.object({
  version: z.string().default('1'),
  project: z.object({
    name: z.string(),
    description: z.string().optional(),
  }),
  service: z.object({
    build: ServiceBuildSchema,
    container: ServiceContainerSchema,
    vars: z.record(z.string()).optional(),
  }),
  mocks: z.record(MockServiceSchema).optional(),
  tests: z.object({
    suites: z.array(TestSuiteSchema),
  }),
  dashboard: DashboardSchema.optional(),
  network: NetworkSchema.optional(),
});

export type E2EConfig = z.infer<typeof E2EConfigSchema>;

// ===== Loader =====

export async function loadConfig(configPath?: string): Promise<E2EConfig> {
  const resolvedPath = configPath || path.resolve(process.cwd(), 'e2e.yaml');
  // 1. Load .env
  dotenv.config({ path: path.resolve(path.dirname(resolvedPath), '.env') });
  // 2. Read & parse YAML
  const raw = await fs.readFile(resolvedPath, 'utf-8');
  const parsed = yaml.load(raw) as Record<string, unknown>;
  // 3. Validate with Zod
  const config = E2EConfigSchema.parse(parsed);
  // 4. Resolve variables in all string values
  return resolveConfigVariables(config);
}
```

**变量替换** 委托给 `variable-resolver.ts`（见下方独立模块）。

---

### 2. variable-resolver — 模板变量解析

**职责**: 递归遍历配置/测试数据中的字符串，替换 `{{...}}` 模板变量。

**支持的变量类型**:

| Pattern | Source | Example |
|---------|--------|---------|
| `{{timestamp}}` | `Date.now()` | `1707753600000` |
| `{{uuid}}` | `crypto.randomUUID()` | `a1b2c3d4-...` |
| `{{date}}` | ISO 8601 | `2026-02-12` |
| `{{env.VAR}}` | `process.env.VAR` | 读取环境变量 |
| `{{varName}}` | 测试上下文变量 | 上一步 save 的值 |
| `{{request.body.field}}` | 请求体字段 (Mock 专用) | 来自请求 |
| `{{request.params.id}}` | 路径参数 (Mock 专用) | 来自 URL |
| `{{request.query.q}}` | 查询参数 (Mock 专用) | 来自 query string |

```typescript
// variable-resolver.ts

export interface VariableContext {
  env: Record<string, string>;         // process.env
  vars: Record<string, unknown>;       // 用户定义变量 + save 的值
  request?: {                          // Mock 服务专用
    body: Record<string, unknown>;
    params: Record<string, string>;
    query: Record<string, string>;
  };
}

export function resolveTemplate(template: string, ctx: VariableContext): string {
  return template.replace(/\{\{(.+?)\}\}/g, (_, expr: string) => {
    const trimmed = expr.trim();
    // Built-in variables
    if (trimmed === 'timestamp') return String(Date.now());
    if (trimmed === 'uuid') return crypto.randomUUID();
    if (trimmed === 'date') return new Date().toISOString().split('T')[0];
    // Environment variables
    if (trimmed.startsWith('env.')) return ctx.env[trimmed.slice(4)] ?? '';
    // Request context (mock)
    if (trimmed.startsWith('request.') && ctx.request) {
      return resolveNestedPath(ctx.request, trimmed.slice(8));
    }
    // User-defined / saved variables
    return String(ctx.vars[trimmed] ?? `{{${trimmed}}}`);
  });
}

/** 递归解析对象/数组中的所有字符串 */
export function resolveDeep<T>(value: T, ctx: VariableContext): T { /* ... */ }
```

---

### 3. yaml-engine — YAML 测试引擎

**职责**: 解析 YAML 测试文件，执行 HTTP 请求序列，调用 assertion-engine 校验，生成 TestEvent 流。

**迁移来源**: 替代 `as-mate/e2e/tests/helpers.ts` 中的命令式测试辅助函数 (`containerRequest`, `waitForHealthy`, `assertSuccess`)。YAML 引擎将这些命令式操作转化为声明式 YAML 定义。

**YAML 测试文件结构**:

```yaml
# tests/example.yaml
name: 示例测试
description: 功能描述
sequential: true          # 强制顺序执行

setup:
  - wait_healthy: { timeout: 60s }
  - request: { method: POST, path: /reset }
    ignore_error: true

teardown:
  - request: { method: POST, path: /cleanup }
    ignore_error: true

variables:
  game_id: "test-{{timestamp}}"
  token: "e2e-token"

cases:
  - name: "创建资源"
    request:
      method: POST
      path: /api/resource
      headers:
        X-Token: "{{token}}"
      body:
        id: "{{game_id}}"
        name: "Test Resource"
      timeout: 30s
    expect:
      status: 200
      headers:
        content-type: { contains: "application/json" }
      body:
        success: 0
        data:
          id: { exists: true, save: resource_id }
    save:
      resource_id: body.data.id

  - name: "查询资源"
    delay: 2s
    request:
      method: GET
      path: /api/resource/{{resource_id}}
    expect:
      status: 200
      body:
        id: "{{resource_id}}"
        name: "Test Resource"
```

**核心执行流**:

```
loadYamlTestFile(filePath)
  ↓
parseYamlTestCase(raw) → YAMLTestCase
  ↓
createVariableContext(config.vars, testCase.variables)
  ↓
runSetupSteps(testCase.setup, ctx)
  ↓
for each case in testCase.cases:
  ├── emit TestEvent { type: 'case_start' }
  ├── applyDelay(case.delay)
  ├── resolveTemplate(case.request, ctx)
  ├── executeHttpRequest(case.request) → response
  ├── runAssertions(case.expect, response) → AssertionResult[]
  ├── extractAndSaveVariables(case.save, response, ctx)
  ├── emit TestEvent { type: 'case_pass' | 'case_fail' }
  └── continue / abort (based on sequential flag)
  ↓
runTeardownSteps(testCase.teardown, ctx) // always runs
  ↓
emit TestEvent { type: 'suite_end' }
```

---

### 4. assertion-engine — 断言 DSL 引擎

**职责**: 实现 YAML `expect` 块中的所有断言操作符，返回结构化的断言结果。

**断言操作符一览**:

| Operator | Example YAML | Semantics |
|----------|-------------|-----------|
| 精确匹配 | `status: ok` | `actual === "ok"` |
| `type` | `idle: { type: boolean }` | `typeof actual === "boolean"` |
| `exists` | `game_id: { exists: true }` | `actual !== undefined && actual !== null` |
| `in` | `status: { in: [a, b] }` | `["a","b"].includes(actual)` |
| `gt` / `gte` | `count: { gt: 0 }` | `actual > 0` |
| `lt` / `lte` | `count: { lte: 100 }` | `actual <= 100` |
| `contains` | `msg: { contains: "ok" }` | `actual.includes("ok")` (string/array) |
| `matches` | `msg: { matches: "^ok" }` | `new RegExp("^ok").test(actual)` |
| `startsWith` | `msg: { startsWith: "Error" }` | `actual.startsWith("Error")` |
| `length` | `items: { length: 5 }` | `actual.length === 5` |
| `length.gt` | `items: { length: { gt: 0 } }` | `actual.length > 0` |
| `save` | `id: { save: my_id }` | save value to context (side-effect) |
| 嵌套对象 | `data: { user: { name: { type: string } } }` | 递归断言 |

**核心接口**:

```typescript
// assertion-engine.ts

export interface AssertionResult {
  path: string;           // e.g., "body.data.user.name"
  operator: string;       // e.g., "type", "contains", "gt"
  expected: unknown;      // 期望值
  actual: unknown;        // 实际值
  passed: boolean;
  message: string;        // 人类可读描述
}

export interface AssertionContext {
  /** 将值保存到变量上下文的回调 */
  saveVariable: (name: string, value: unknown) => void;
}

/**
 * 对 actual 值运行断言规则树，返回所有断言结果。
 *
 * @param expected - YAML expect 块解析后的对象
 * @param actual   - HTTP 响应数据 (body, headers, status)
 * @param basePath - 当前路径前缀，用于嵌套断言
 * @param ctx      - 断言上下文（save 回调等）
 */
export function runAssertions(
  expected: unknown,
  actual: unknown,
  basePath: string,
  ctx: AssertionContext,
): AssertionResult[] { /* ... */ }
```

**错误信息格式** (断言失败时):

```
Assertion FAILED at body.data.count
  Operator: gt
  Expected: > 0
  Actual:   -1
```

---

### 5. docker-engine — Docker 引擎

**迁移来源**: `as-mate/e2e/server/routes/docker.ts` — 提取 Docker 镜像构建、容器生命周期管理、网络管理、健康检查等核心逻辑，去除 as-mate 特有的硬编码（仓库路径、容器名、端口映射等），全部改为从 `E2EConfig` 读取。

**迁移映射**:

| 原始代码 (`docker.ts`) | 新模块 (`docker-engine.ts`) | 变化 |
|------------------------|---------------------------|------|
| `getDefaultImageName()` — 读取 as-mate/package.json | 移除，镜像名从 `config.service.build.image` 读取 | 去除硬编码 |
| `getGitBranches()` / `checkoutAndPull()` | 保留为可选功能（Dashboard 特有），放入 dashboard routes | 拆分 |
| `buildState` / `containerState` 全局变量 | 封装为 `DockerEngine` class 的实例状态 | 封装 |
| `ensureNetwork()` | `DockerEngine.ensureNetwork(name)` | 通用化 |
| `containerExists()` / `containerRunning()` | `DockerEngine.getContainerStatus(name)` | 合并 |
| `broadcast()` SSE | 改为 `EventEmitter`，由 SSE bus 订阅 | 解耦 |
| `/build` POST handler — spawn docker build | `DockerEngine.buildImage(config)` → AsyncGenerator<BuildEvent> | 纯逻辑 |
| `/start` POST handler — docker run + mock-gateway | `DockerEngine.startContainer(config)` + `MockGenerator.start()` | 拆分 |
| `/stop` POST handler | `DockerEngine.stopContainer(name)` | 通用化 |
| `/logs` GET handler | `DockerEngine.getLogs(name, options)` | 通用化 |
| `/logs/stream` SSE handler | `DockerEngine.streamLogs(name)` → AsyncGenerator<string> | 纯逻辑 |
| `/processes` GET handler | `DockerEngine.getProcesses(name)` | 通用化 |
| `/dirs` GET handler | `DockerEngine.listDirectory(name, path)` | 通用化 |
| `/exec` POST handler | `DockerEngine.exec(name, command)` | 通用化 |
| 端口映射硬编码 (`19000:3000`) | 从 `config.service.container.ports` 读取 | 配置化 |
| 环境变量硬编码 (`AS_MATE_*`) | 从 `config.service.container.environment` 读取 | 配置化 |

**核心接口**:

```typescript
// docker-engine.ts

export interface BuildOptions {
  dockerfile: string;
  context: string;
  imageName: string;
  buildArgs?: Record<string, string>;
  noCache?: boolean;
}

export interface ContainerOptions {
  name: string;
  image: string;
  ports: string[];                    // "hostPort:containerPort"
  environment?: Record<string, string>;
  volumes?: string[];
  network?: string;
  healthcheck?: {
    path: string;
    interval: string;
    timeout: string;
    retries: number;
    startPeriod: string;
  };
}

export type BuildEvent =
  | { type: 'log'; stream: 'stdout' | 'stderr'; line: string }
  | { type: 'status'; status: 'building' | 'success' | 'error'; error?: string };

export type ContainerEvent =
  | { type: 'log'; stream: 'stdout' | 'stderr'; line: string }
  | { type: 'status'; status: 'starting' | 'running' | 'stopping' | 'stopped' | 'error'; error?: string };

export class DockerEngine {
  /** 构建 Docker 镜像，返回 AsyncGenerator 流式输出 */
  async *buildImage(options: BuildOptions): AsyncGenerator<BuildEvent>;

  /** 启动容器 */
  async startContainer(options: ContainerOptions): Promise<string>; // containerId

  /** 停止并移除容器 */
  async stopContainer(name: string): Promise<void>;

  /** 等待容器健康就绪 */
  async waitForHealthy(name: string, healthPath: string, timeoutMs: number): Promise<void>;

  /** 确保 Docker 网络存在 */
  async ensureNetwork(name: string): Promise<void>;

  /** 获取容器状态 */
  async getContainerStatus(name: string): Promise<ContainerStatus>;

  /** 流式输出容器日志 */
  async *streamLogs(name: string, tail?: number): AsyncGenerator<string>;

  /** 获取静态日志 */
  async getLogs(name: string, tail?: number): Promise<string>;

  /** 在容器内执行命令 */
  async exec(name: string, command: string): Promise<{ output: string; exitCode: number }>;

  /** 获取容器进程列表 */
  async getProcesses(name: string): Promise<ProcessInfo[]>;

  /** 列出容器目录 */
  async listDirectory(name: string, dirPath: string): Promise<DirectoryEntry[]>;

  /** 检查端口冲突 */
  async checkPortConflicts(ports: string[]): Promise<PortConflict[]>;

  /** 清理所有资源（容器、网络、卷） */
  async cleanup(options: CleanupOptions): Promise<void>;
}
```

**实现策略**: 通过 `child_process.spawn` / `child_process.execSync` 调用 Docker CLI（与现有 as-mate/e2e 一致），不引入 Docker SDK 以减少依赖。

---

### 6. mock-generator — Mock 服务生成器

**迁移来源**: `as-mate/e2e/server/mock-gateway.ts` — 将硬编码的 VAG 游戏平台 Mock 路由，改为从 `e2e.yaml` 的 `mocks` 配置声明式生成。

**迁移映射**:

| 原始代码 (`mock-gateway.ts`) | 新模块 (`mock-generator.ts`) | 变化 |
|----------------------------|---------------------------|------|
| 硬编码路由 (`/api/v1/games_save_check` 等) | 从 `config.mocks[name].routes` 动态注册 | 配置化 |
| `requestLog` 全局数组 | 每个 Mock 服务实例独立的请求记录 | 封装 |
| `/_mock/requests`, `/_mock/health` | 自动为每个 Mock 服务添加 `/_mock/*` 管理接口 | 通用化 |
| 直接 `app.listen()` 启动 | 支持两种模式：本地进程 / Docker 容器 | 扩展 |
| 路径参数 (`:gameId`) 由 Fastify 内置支持 | 保持 Fastify 路由参数语法 | 不变 |
| 条件路由不支持 | 新增 `when` 条件匹配 | 新增 |
| 响应延迟不支持 | 新增 `response.delay` 模拟延迟 | 新增 |

**核心接口**:

```typescript
// mock-generator.ts

export interface MockServiceConfig {
  name: string;
  port: number;
  containerPort?: number;
  routes: MockRouteConfig[];
}

export interface MockRouteConfig {
  method: string;
  path: string;
  response: {
    status: number;
    headers?: Record<string, string>;
    body: unknown;
    delay?: string;
  };
  when?: {
    body?: Record<string, unknown>;
    headers?: Record<string, string>;
    query?: Record<string, string>;
  };
}

export class MockGenerator {
  /**
   * 从配置生成 Fastify Mock 服务实例（不启动）
   * 自动注册: /_mock/health, /_mock/requests, /_mock/routes, DELETE /_mock/requests
   */
  createMockApp(config: MockServiceConfig): FastifyInstance;

  /**
   * 将 Mock 服务打包为 Docker 镜像
   * 1. 生成 mock-server.ts (注册所有路由的 Fastify app)
   * 2. 生成 Dockerfile
   * 3. docker build → image
   */
  async buildMockImage(config: MockServiceConfig): Promise<string>; // imageName

  /**
   * 以 Docker 容器方式启动 Mock 服务
   */
  async startAsContainer(
    config: MockServiceConfig,
    network: string,
    docker: DockerEngine,
  ): Promise<string>; // containerId

  /**
   * 以本地进程方式启动 Mock 服务（开发/调试用）
   */
  async startLocal(config: MockServiceConfig): Promise<FastifyInstance>;
}
```

**Docker 容器模式**: 将 Mock 服务打包为轻量 Docker 镜像运行在同一 Docker network 中，这样被测服务容器可以通过容器名直接访问 Mock 服务（如 `http://gateway-e2e:8081`）。

---

### 7. test-runner — 测试运行器框架

**迁移来源**: `as-mate/e2e/server/routes/test.ts` — 将硬编码的 Vitest 测试套件列表和运行逻辑，改为可插拔的多运行器架构。

**迁移映射**:

| 原始代码 (`test.ts`) | 新模块 (`test-runner.ts` + `runners/`) | 变化 |
|---------------------|--------------------------------------|------|
| `TEST_SUITES` 硬编码字典 | 从 `config.tests.suites` 动态读取 | 配置化 |
| 固定调用 `npx vitest` | 根据 `suite.runner` 选择对应 TestRunner | 可插拔 |
| `currentTest` / `testHistory` 全局状态 | `TestOrchestrator` 类封装 | 封装 |
| `stripAnsi` + stdout 收集 | 每个 Runner 实现 `run()` 返回 `AsyncGenerator<TestEvent>` | 标准化 |
| `/suites` GET handler | Dashboard route 调用 `config.tests.suites` | 拆分 |
| `/run` POST handler | `TestOrchestrator.runSuite(suiteId)` | 纯逻辑 |
| `/stream` SSE handler | SSE bus 订阅 `TestEvent` | 解耦 |

**核心接口**:

```typescript
// test-runner.ts

export interface TestRunner {
  /** 运行器 ID (yaml, vitest, pytest, shell, exec) */
  readonly id: string;

  /** 运行测试，返回 TestEvent 流 */
  run(config: RunConfig): AsyncGenerator<TestEvent>;

  /** 检查运行器是否可用（依赖检查） */
  available(): Promise<boolean>;
}

export interface RunConfig {
  cwd: string;
  target: string;           // 文件路径或命令
  env: Record<string, string>;
  timeout: number;          // 毫秒
  options?: Record<string, unknown>;
}

export type TestEvent =
  | { type: 'suite_start'; suiteId: string; name: string; timestamp: number }
  | { type: 'case_start'; suiteId: string; caseName: string; timestamp: number }
  | { type: 'case_pass'; suiteId: string; caseName: string; duration: number; timestamp: number }
  | { type: 'case_fail'; suiteId: string; caseName: string; error: string; duration: number; assertions?: AssertionResult[]; timestamp: number }
  | { type: 'suite_end'; suiteId: string; passed: number; failed: number; skipped: number; duration: number; timestamp: number }
  | { type: 'log'; suiteId: string; level: 'info' | 'warn' | 'error'; message: string; timestamp: number };

/** 运行器注册表 */
export class RunnerRegistry {
  register(runner: TestRunner): void;
  get(id: string): TestRunner | undefined;
  list(): TestRunner[];
}

/** 测试编排器 — 管理测试执行、历史记录、事件分发 */
export class TestOrchestrator {
  constructor(config: E2EConfig, registry: RunnerRegistry, bus: SSEBus);

  /** 运行指定测试套件 */
  async *runSuite(suiteId: string): AsyncGenerator<TestEvent>;

  /** 运行所有测试套件 */
  async *runAll(): AsyncGenerator<TestEvent>;

  /** 获取测试历史 */
  getHistory(limit?: number): TestResult[];

  /** 获取当前运行状态 */
  getCurrent(): TestResult | null;
}
```

**内置运行器实现**:

| Runner | `run()` 实现 | 输出解析 |
|--------|-------------|---------|
| `yaml-runner` | 调用 `yaml-engine` 执行 YAML 测试 | 直接生成 TestEvent |
| `vitest-runner` | `spawn('npx', ['vitest', 'run', ...])` | 解析 stdout 文本 → TestEvent |
| `pytest-runner` | `spawn('pytest', [...])` | 解析 pytest 输出 → TestEvent |
| `shell-runner` | `spawn('bash', ['-e', scriptPath])` | exit code → pass/fail |
| `exec-runner` | `spawn(command, args)` | exit code → pass/fail |

---

### 8. sse-bus — SSE 事件总线

**职责**: 统一管理所有 SSE 事件的发布/订阅，供 Dashboard 和 CLI 消费。

**迁移来源**: `as-mate/e2e/server/routes/docker.ts` 中的 `sseClients` Set 和 `broadcast()` 函数 — 从分散在各 route 文件的 SSE 逻辑统一收归到一个事件总线。

```typescript
// sse-bus.ts

export type SSEChannel = 'build' | 'container' | 'test' | 'mock' | 'system';

export interface SSEMessage {
  channel: SSEChannel;
  event: string;           // e.g., "build-log", "container-state", "test-event"
  data: unknown;
  id?: string;             // Event ID for reconnection
  timestamp: number;
}

export class SSEBus {
  /** 发布事件 */
  publish(message: SSEMessage): void;

  /** 订阅事件（Fastify reply 的 SSE 连接） */
  subscribe(channels: SSEChannel[], callback: (msg: SSEMessage) => void): () => void;

  /** 获取频道最近 N 条历史消息（支持 Last-Event-ID 恢复） */
  getHistory(channel: SSEChannel, sinceId?: string, limit?: number): SSEMessage[];
}
```

---

### 9. reporter — 测试报告生成

**职责**: 将 TestEvent 流汇总为测试报告，支持多种输出格式。

```typescript
// reporter.ts

export type ReportFormat = 'console' | 'json' | 'html' | 'tap';

export interface TestReport {
  project: string;
  timestamp: number;
  duration: number;
  suites: SuiteReport[];
  summary: {
    total: number;
    passed: number;
    failed: number;
    skipped: number;
    duration: number;
  };
}

export interface Reporter {
  readonly format: ReportFormat;
  generate(report: TestReport): string;
}

export class ConsoleReporter implements Reporter { /* ... */ }
export class JsonReporter implements Reporter { /* ... */ }
export class HtmlReporter implements Reporter { /* ... */ }
export class TapReporter implements Reporter { /* ... */ }
```

---

## Migration Mapping Summary (as-mate/e2e → preflight)

| Source File | Target Module | Migration Strategy |
|------------|---------------|-------------------|
| `server/index.ts` | `packages/dashboard/server/index.ts` | 重构：去除 as-mate 硬编码，改为从 config 读取 |
| `server/routes/docker.ts` | `packages/core/src/docker-engine.ts` + `packages/dashboard/server/routes/docker.ts` | 拆分：纯逻辑进 core，HTTP handler 留 dashboard |
| `server/routes/test.ts` | `packages/core/src/test-runner.ts` + `packages/dashboard/server/routes/test.ts` | 拆分：测试执行逻辑进 core，API route 留 dashboard |
| `server/routes/proxy.ts` | `packages/dashboard/server/routes/proxy.ts` | 平移：逻辑简单通用，直接搬迁 |
| `server/routes/config.ts` | `packages/dashboard/server/routes/config.ts` | 重构：改为读写 `e2e.yaml` |
| `server/mock-gateway.ts` | `packages/core/src/mock-generator.ts` | 重大重构：硬编码路由 → 声明式配置生成 |
| `tests/helpers.ts` | 被 `packages/core/src/yaml-engine.ts` 替代 | 替代：命令式 helper → 声明式 YAML 引擎 |
| 前端代码 (pages, stores) | `packages/dashboard/ui/` | 平移 + 重构：去除 as-mate 特有 UI，通用化 |
| `package.json` | 各 `packages/*/package.json` | 拆分：依赖分配到对应包 |

---

## Key Interface Definitions

### E2EConfig (完整类型)

```typescript
export interface E2EConfig {
  version: string;
  project: {
    name: string;
    description?: string;
  };
  service: {
    build: {
      dockerfile: string;
      context: string;
      image: string;
      args?: Record<string, string>;
      no_cache?: boolean;
    };
    container: {
      name: string;
      ports: string[];
      environment?: Record<string, string>;
      volumes?: string[];
      healthcheck?: {
        path: string;
        interval: string;
        timeout: string;
        retries: number;
        start_period: string;
      };
    };
    vars?: Record<string, string>;
  };
  mocks?: Record<string, {
    port: number;
    container_port?: number;
    image?: string;
    routes?: MockRouteConfig[];
  }>;
  tests: {
    suites: TestSuiteConfig[];
  };
  dashboard?: {
    port: number;
    ui_port: number;
  };
  network?: {
    name: string;
  };
}
```

### TestEvent (统一事件)

```typescript
export type TestEvent =
  | { type: 'suite_start'; suiteId: string; name: string; timestamp: number }
  | { type: 'case_start'; suiteId: string; caseName: string; timestamp: number }
  | { type: 'case_pass'; suiteId: string; caseName: string; duration: number; timestamp: number }
  | { type: 'case_fail'; suiteId: string; caseName: string; error: string; duration: number; assertions?: AssertionResult[]; timestamp: number }
  | { type: 'case_skip'; suiteId: string; caseName: string; reason: string; timestamp: number }
  | { type: 'suite_end'; suiteId: string; passed: number; failed: number; skipped: number; duration: number; timestamp: number }
  | { type: 'log'; suiteId: string; level: 'info' | 'warn' | 'error'; message: string; timestamp: number };
```

### AssertionResult

```typescript
export interface AssertionResult {
  path: string;           // "body.data.user.name"
  operator: string;       // "type", "contains", "gt", "exact"
  expected: unknown;
  actual: unknown;
  passed: boolean;
  message: string;        // Human-readable
}
```

### MockRouteConfig

```typescript
export interface MockRouteConfig {
  method: string;
  path: string;
  response: {
    status: number;
    headers?: Record<string, string>;
    body: unknown;
    delay?: string;
  };
  when?: {
    body?: Record<string, unknown>;
    headers?: Record<string, string>;
    query?: Record<string, string>;
  };
}
```

---

## Dependency Inventory

### packages/core

| Dependency | Version | Purpose |
|-----------|---------|---------|
| `zod` | ^3.23 | e2e.yaml schema validation |
| `js-yaml` | ^4.1 | YAML parsing |
| `dotenv` | ^16.4 | .env file loading |
| `fastify` | ^5.0 | Mock service generation (createMockApp) |

Dev dependencies:

| Dependency | Version | Purpose |
|-----------|---------|---------|
| `vitest` | ^2.1 | Unit + integration testing |
| `typescript` | ~5.9 | Compilation |
| `@types/js-yaml` | ^4.0 | Type definitions |
| `@types/node` | ^22.0 | Node.js type definitions |

### packages/dashboard

| Dependency | Version | Purpose |
|-----------|---------|---------|
| `@preflight/core` | `workspace:*` | Core engine APIs |
| `fastify` | ^5.0 | API server |
| `@fastify/cors` | ^10.0 | CORS support |
| `@fastify/static` | ^8.3 | Static file serving |
| `react` | ^19.2 | UI framework |
| `react-dom` | ^19.2 | React DOM renderer |
| `react-router-dom` | ^7.13 | Client-side routing |
| `zustand` | ^5.0 | State management |

Dev dependencies:

| Dependency | Version | Purpose |
|-----------|---------|---------|
| `vite` | ^7.2 | Frontend build tool |
| `@vitejs/plugin-react` | ^5.1 | React Vite plugin |
| `tailwindcss` | ^4.1 | Utility-first CSS |
| `@tailwindcss/vite` | ^4.1 | Tailwind Vite integration |
| `tsx` | ^4.19 | TypeScript execution (dev server) |
| `concurrently` | ^9.0 | Parallel dev scripts |
| `typescript` | ~5.9 | Compilation |
| `vitest` | ^2.1 | Testing |

### packages/cli

| Dependency | Version | Purpose |
|-----------|---------|---------|
| `@preflight/core` | `workspace:*` | Core engine APIs |
| `commander` | ^12.1 | CLI framework |
| `chalk` | ^5.3 | Terminal colors |
| `ora` | ^8.1 | Terminal spinners |

Dev dependencies:

| Dependency | Version | Purpose |
|-----------|---------|---------|
| `typescript` | ~5.9 | Compilation |
| `vitest` | ^2.1 | Testing |

---

## Implementation Priority

### Phase 1 — Foundation (MVP Core)

**Goal**: 可以通过代码 API 加载配置、构建镜像、启动容器、运行 YAML 测试

| # | Task | Module | FR Coverage |
|---|------|--------|-------------|
| 1.1 | Monorepo 脚手架搭建 (package.json, pnpm-workspace.yaml, tsconfig) | root | — |
| 1.2 | `types.ts` 定义所有核心接口 | core | — |
| 1.3 | `config-loader.ts` 实现 (Zod schema + YAML 加载 + .env) | core | FR-001~009 |
| 1.4 | `variable-resolver.ts` 实现 | core | FR-006, FR-017~018 |
| 1.5 | `assertion-engine.ts` 实现 (全部断言操作符) | core | FR-012, FR-019 |
| 1.6 | `docker-engine.ts` 实现 (build, start, stop, health, cleanup) | core | FR-029~039 |
| 1.7 | `yaml-engine.ts` 实现 (YAML 测试解析 + HTTP 执行) | core | FR-010~018 |
| 1.8 | `test-runner.ts` 框架 + `yaml-runner.ts` | core | FR-020, FR-025 |
| 1.9 | 单元测试: config-loader, assertion-engine, variable-resolver | core/tests | NFR-006 |

### Phase 2 — Mock + SSE

**Goal**: Mock 服务声明式生成，SSE 事件总线

| # | Task | Module | FR Coverage |
|---|------|--------|-------------|
| 2.1 | `mock-generator.ts` 实现 (Fastify 动态路由 + /_mock/* + Docker 打包) | core | FR-040~047 |
| 2.2 | `sse-bus.ts` 实现 | core | FR-054, NFR-007 |
| 2.3 | `reporter.ts` 实现 (console + json) | core | FR-067 |
| 2.4 | 其他内置 Runner: vitest-runner, shell-runner, exec-runner | core/runners | FR-021~024, FR-026~028 |
| 2.5 | 集成测试: yaml-runner + mock-generator 联合测试 | core/tests | SC-006, SC-007 |

### Phase 3 — CLI

**Goal**: `preflight` 命令行工具可用

| # | Task | Module | FR Coverage |
|---|------|--------|-------------|
| 3.1 | CLI 框架搭建 (Commander.js + bin entry) | cli | FR-065 |
| 3.2 | `init` 命令 (生成 e2e.yaml 模板) | cli | FR-057 |
| 3.3 | `setup` 命令 (依赖检查 + build + start + health) | cli | FR-058 |
| 3.4 | `build` 命令 (镜像构建 + SSE 日志打印) | cli | FR-063 |
| 3.5 | `run` 命令 (测试执行 + --suite + --ci + --reporter) | cli | FR-059, FR-066, FR-067 |
| 3.6 | `status`, `clean`, `logs` 命令 | cli | FR-060~062, FR-064 |
| 3.7 | `dashboard` 命令 (启动 Dashboard) | cli | FR-062 |

### Phase 4 — Dashboard

**Goal**: Web Dashboard 可视化

| # | Task | Module | FR Coverage |
|---|------|--------|-------------|
| 4.1 | Dashboard server 搭建 (Fastify + routes) | dashboard/server | FR-048, FR-055 |
| 4.2 | Docker routes (构建/启动/停止/日志/SSE) | dashboard/server | FR-050~051 |
| 4.3 | Test routes (运行/历史/SSE 流) | dashboard/server | FR-053 |
| 4.4 | Proxy routes + Mock routes + Config routes | dashboard/server | FR-052 |
| 4.5 | React UI 框架搭建 (Layout, Router, Stores) | dashboard/ui | FR-049 |
| 4.6 | BuildPage (镜像构建 + SSE 日志) | dashboard/ui | FR-050 |
| 4.7 | ContainerPage (容器管理 + 实时日志 + 进程列表) | dashboard/ui | FR-051 |
| 4.8 | ApiExplorerPage (API 调试代理) | dashboard/ui | FR-052 |
| 4.9 | TestSuitesPage (测试运行 + 实时事件 + 历史) | dashboard/ui | FR-053 |
| 4.10 | SSE 日志组件 (SSELogViewer, 通用) | dashboard/ui | FR-054 |

### Phase 5 — Polish & CI (Post-MVP)

| # | Task | Module | FR Coverage |
|---|------|--------|-------------|
| 5.1 | `pytest-runner.ts` 实现 | core/runners | FR-022 |
| 5.2 | HTML reporter | core | — |
| 5.3 | TAP reporter | core | — |
| 5.4 | 测试历史持久化 (JSON 文件) | dashboard | FR-056 |
| 5.5 | SSE 断线重连 + Last-Event-ID | core | NFR-007 |
| 5.6 | CI 模式优化 (`--ci` 无交互, 资源清理) | cli | SC-010 |
| 5.7 | as-mate 测试迁移到 YAML (验证 SC-001) | — | SC-001 |
| 5.8 | README + 快速开始文档 | root | SC-005 |
| 5.9 | 整体测试覆盖率达标 | all | NFR-006 |

---

## Complexity Tracking

> No constitution violations identified. All design decisions align with the 10 principles.

| Decision | Justification | Simpler Alternative Rejected Because |
|----------|--------------|-------------------------------------|
| Monorepo 3 包拆分 | core/dashboard/cli 职责清晰，core 可独立使用 | 单包会导致 CLI 用户强制安装 React 等 Dashboard 依赖 |
| Mock 服务 Docker 容器化 | 被测服务在 Docker 网络中，Mock 需同网络可访问 | 本地进程 Mock 无法被容器直接访问（需 host.docker.internal 不可靠） |
| AsyncGenerator 用于 Build/Test/Log | 流式输出天然适合 SSE/CLI 消费 | Callback/EventEmitter 不支持 for-await-of 消费模式 |
| Zod 用于配置校验 | 类型安全 + 清晰错误信息 + 自动类型推导 | 手写校验代码量大且容易遗漏边界情况 |

---

## Open Questions Resolution (from spec)

| # | Question | Decision for MVP |
|---|----------|-----------------|
| Q-001 | Mock 是否支持 WebSocket | MVP 仅支持 HTTP/HTTPS，WebSocket 列入 Phase 5+ |
| Q-002 | 测试套件是否支持并行执行 | MVP 套件间顺序执行，套件内 cases 支持 `sequential: true/false`；并行隔离列入 Phase 5+ |
| Q-003 | Dashboard 是否需要用户认证 | MVP 仅本地访问，无认证；远程访问认证列入 Phase 5+ |
| Q-004 | 是否支持测试数据持久化 | MVP 每次测试使用全新容器（零侵入原则）；持久化卷可通过 volumes 配置实现 |
| Q-005 | 是否支持多容器服务 | MVP 支持单主服务 + 多 Mock 服务；多主服务编排列入 Phase 5+ |
